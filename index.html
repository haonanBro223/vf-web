<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VexFlow Sheet</title>
  <!-- 1. 引入 UMD 构建 -->
  <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.3/releases/vexflow-min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
     /* 输出容器允许溢出，并给左侧留出 20px 空间 */
    #output {
       overflow: visible;
       padding-left: 20px;
    }
     /* SVG 本身允许溢出 */
    svg {
       overflow: visible;
    }
  </style>
</head>
<body>
  <div id="output"></div>
  <script>
    // 2. 使用全局 Vex
    const VF = Vex.Flow;
    const urlParams = new URLSearchParams(window.location.search);
    const note = urlParams.get('note');
    
    const div = document.getElementById("output");
    const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
    renderer.resize(700, 300);
    const context = renderer.getContext();

    const treble = new VF.Stave(40, 40, 300)
        .addClef("treble")
        .setContext(context)
        .setEndBarType(VF.Barline.type.NONE)  // 取消右端竖线
        .draw();

    const bass = new VF.Stave(40, 140, 300)     
       .addClef("bass")
       .setContext(context)
       .setEndBarType(VF.Barline.type.NONE)  // 取消右端竖线
       .draw();
    
    // —— 在两条谱表之间画左侧花括号 ——  
    new VF.StaveConnector(treble, bass)
      .setType(VF.StaveConnector.type.BRACE)
      .setContext(context)
      .draw();

    new VF.StaveConnector(treble, bass)
      .setType(VF.StaveConnector.type.SINGLE)
      .setContext(context)
      .setLineThickness(2)
      .draw();
    
    if (note) {
      const parts = note.toLowerCase().match(/^([a-g])(#?)(\d)$/);
      if (!parts) throw new Error("Invalid note: " + note);
      const [_, l, s, o] = parts;
      const key = `${l}/${o}`;

            // 15. 根据八度判断绘制在哪个谱表：4 及以上用高音谱号，小于 4 用低音谱号
      const octaveNum = parseInt(o, 10);
      const useTreble = octaveNum >= 4;
      // 16. 创建对应谱表的音符
      const noteObj = new VF.StaveNote({
        clef: useTreble ? "treble" : "bass",
        keys: [key],
        duration: "q",
      });
      // 17. 如果有升号，则添加 Accidentals
      if (s) noteObj.addAccidental(0, new VF.Accidental("#"));
      // 18. 创建 Voice 对象并添加音符
      const voice = new VF.Voice({ num_beats: 1, beat_value: 4 }).addTickables([noteObj]);
      // 20. 格式化并布局音符
      new VF.Formatter().joinVoices([voice]).format([voice], 500);
      // 21. 在对应的谱表上绘制音符
      voice.draw(context, useTreble ? treble : bass);
    }
  </script>
</body>
</html>
